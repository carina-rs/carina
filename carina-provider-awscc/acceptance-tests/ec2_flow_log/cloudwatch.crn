# EC2 Flow Log - CloudWatch Logs destination test
#
# Tests: log_destination_type=cloud-watch-logs, log_group_name,
#        deliver_logs_permission_arn, IAM role with nested policy document

provider awscc {
  region = awscc.Region.ap_northeast_1
}

let vpc = awscc.ec2.vpc {
  cidr_block = "10.0.0.0/16"
}

let log_group = awscc.logs.log_group {
  log_group_name    = "/acceptance-test/vpc-flow-logs"
  retention_in_days = 1
}

let flow_log_role = awscc.iam.role {
  role_name = "acceptance-test-flow-log-role"
  assume_role_policy_document = {
    version = "2012-10-17"
    statement = [
      {
        effect    = "Allow"
        principal = { service = "vpc-flow-logs.amazonaws.com" }
        action    = "sts:AssumeRole"
      }
    ]
  }
}

let flow_log = awscc.ec2.flow_log {
  resource_id                 = vpc.vpc_id
  resource_type               = VPC
  traffic_type                = ALL
  log_destination_type        = cloud_watch_logs
  log_group_name              = log_group.log_group_name
  deliver_logs_permission_arn = flow_log_role.arn

  tags = {
    Environment = "acceptance-test"
  }
}
