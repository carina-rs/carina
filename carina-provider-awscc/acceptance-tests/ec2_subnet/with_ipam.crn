# EC2 Subnet - IPAM test
#
# Tests: ipv4_ipam_pool_id, ipv4_netmask_length
# Requires: IPAM and IPAM Pool
#
# Known issues:
# - IPAM Pool provisioned CIDR needs propagation time before subnet
#   can allocate from it. Apply may fail with "missing source resource".
# - IPAM Pool deletion times out via CloudControl API.

provider awscc {
  region = aws.Region.ap_northeast_1
}

let ipam = awscc.ec2_ipam {
  name = "acceptance-test-ipam-subnet"
  tier = advanced

  operating_regions = [
    {
      region_name = "ap-northeast-1"
    }
  ]
}

let ipam_pool = awscc.ec2_ipam_pool {
  name           = "acceptance-test-ipam-pool-subnet"
  ipam_scope_id  = ipam.private_default_scope_id
  address_family = "IPv4"
  locale         = "ap-northeast-1"

  provisioned_cidrs = [
    {
      cidr = "10.0.0.0/8"
    }
  ]
}

let vpc = awscc.ec2_vpc {
  name                = "acceptance-test-vpc-subnet-ipam"
  ipv4_ipam_pool_id   = ipam_pool.ipam_pool_id
  ipv4_netmask_length = 16
}

awscc.ec2_subnet {
  name                = "acceptance-test-subnet-ipam"
  vpc_id              = vpc.vpc_id
  ipv4_ipam_pool_id   = ipam_pool.ipam_pool_id
  ipv4_netmask_length = 24
  availability_zone   = "ap-northeast-1a"

  tags = {
    Environment = "acceptance-test"
  }
}
